#!/bin/bash

DEPLOYER_DIR=$PWD/node_modules/@croquiscom/croquis.deployer
if [ ! -d $DEPLOYER_DIR ]; then
  # for sample
  DEPLOYER_DIR=$PWD/..
fi

BRANCH=`git branch | awk '/\*/ { print $2; }'`
REF=`git show-ref --heads $BRANCH`
REF=${REF:0:7}

source $DEPLOYER_DIR/bin/_read_config.sh

#echo !- Build documentation
#cake doc

function deploy_ec2 {
  TARGET=work/$CONFIG_PROJECT

  echo !- Sync sources with server
  rm -f log/* upload_tmp/* cov.html
  ssh $CONFIG_SERVER mkdir -p work
  rsync -az --delete --exclude node_modules --copy-unsafe-links . $CONFIG_SERVER:$TARGET

  rsync -az --delete $DEPLOYER_DIR/bin/_deploy_on_server.sh $CONFIG_SERVER:$TARGET
  rsync -az --delete $DEPLOYER_DIR/bin/run_job.sh $CONFIG_SERVER:$TARGET
  rsync -az --delete $DEPLOYER_DIR/bin/on_boot.sh $CONFIG_SERVER:$TARGET
  ssh $CONFIG_SERVER $TARGET/_deploy_on_server.sh $CONFIG_PROJECT $REF
}

function deploy_eb {
  DATE=`date +'%Y%m%d-%H%M'`
  FILENAME=$DATE-$REF.zip
  zip -q -r $FILENAME .ebextensions * -x "node_modules/*" "doc/*" "test/*" "crojsdoc.yaml" "Cakefile"
}

if [[ -z "$CONFIG_ELASTICBEANSTALK_REGION" ]]; then
  deploy_ec2
else
  deploy_eb
fi
